<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>修改</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../../../static/admin/layui/css/layui.css">
    <script src="../../../../../static/admin/layui/layui.js"></script>
    <link rel="stylesheet" href="../../../../../static/admin/css/admin.css">
    <script src="../../../../../static/admin/js/jquery-3.3.1.min.js"></script>
    <!--[if IE 8]>
    <script src="../../../../../static/admin/js/jquery-1.11.3.min.js"></script>
    <![endif]-->
    <script src="../../../../../static/admin/js/basic.js"></script>
</head>
<body>


<div class="layui-row" style="margin: 20px">
    <div class="col-xs-12">
        <!--        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>修改</legend>
        </fieldset>-->

        <form class="layui-form layui-form-pane" action="" >
            <div class="layui-row ">
                <div class="col-xs-12">
                    <div class="col-xs-6" style="padding: 10px;">
                        <input type="hidden"  autocomplete="off" class="layui-input inspPlanId">

                        <div class="layui-form-item" style="margin-bottom:20px ">
                            <label class="layui-form-label">计划名称</label>
                            <div class="layui-input-block">
                                <input type="text" name="inspPlName"  autocomplete="off"  class="layui-input inspPlName">
                            </div>
                        </div>

                        <div class="layui-form-item"  style="margin-bottom:20px ">
                            <label class="layui-form-label">制定时间</label>
                            <div class="layui-input-block">
                                <input type="text"  readonly="readonly"  id="date" lay-verify="date" placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input inspPlCreateTime">
                            </div>
                        </div>

                        <div class="layui-form-item"  style="margin-bottom:20px ">
                            <label class="layui-form-label">计划巡检日期</label>
                            <div class="layui-input-block">
                                <input type="text" name="inspPlLastTime"   readonly="readonly"  id="date1" lay-verify="date" placeholder="yyyy-MM-dd" autocomplete="off" class="layui-input inspPlLastTime">
                            </div>
                        </div>

                        <div class="layui-form-item" style="margin-bottom:20px ">
                            <label class="layui-form-label" style="height:46px;line-height:30px;">审核人</label>
                            <div class="layui-input-block">
                                <input type="text" name="inspPlSpare4" placeholder="请选择"
                                       autocomplete="off" disabled class="layui-input inspPlSpare4"
                                       style="height:46px;padding-left:60px;" >
                                <input type="hidden" id="inspPlAuditor">
                                <button class="layui-btn layui-btn-normal layui-btn-sm PoAb0xx0"
                                        lay-filter="shenName" id="shenName">选择
                                </button>
                            </div>
                        </div>

                        <input type="hidden" id="inspPlPlanner">

                        <div class="layui-form-item" style="margin-bottom:20px ">
                            <label class="layui-form-label">执行人类别</label>
                            <div class="layui-input-block">
                                <select name="inspPlExecutorType" id="inspPlExecutorType">
                                    <option value="">请选择</option>
                                    <option value="0">维修工程师</option>
                                    <option value="1">厂家工程师</option>
                                    <option value="2">维修、厂家工程师</option>
                                </select>
                            </div>
                        </div>

                        <div class="layui-form-item" style="margin-bottom:20px ">
                            <label class="layui-form-label">巡检类型</label>
                            <div class="layui-input-block">
                                <select name="inspPlType" id="inspPlType" >
                                    <option value="">请选择</option>
                                    <option value="0">其它巡检</option>
                                    <option value="1">周期巡检</option>
                                </select>
                            </div>
                        </div>


                    </div>
                    <div class="col-xs-6" style="padding: 10px;">
                        <div class="layui-form-item layui-form-text">
                            <label class="layui-form-label">备注</label>
                            <div class="layui-input-block">
                                <textarea placeholder="" name="inspPlNote"  style="resize:none"  class="layui-textarea inspPlNote"></textarea>
                            </div>
                        </div>

                        <div class="layui-form-item" style="margin-bottom:33px ">
                            <label class="layui-form-label">巡检周期</label>
                            <div class="layui-input-block">
                                <input type="text" name="inspPlPeriod" id="inspPlPeriod" placeholder="只能输入数字" autocomplete="off" class="layui-input" oninput="value=value.replace(/[^\d]/g,'')">
                            </div>
                        </div>

                        <div class="layui-form-item" style="margin-bottom:33px ">
                            <label class="layui-form-label">周期单位</label>
                            <div class="layui-input-block">
                                <select name="inspPlPeriodicUnit" id="inspPlPeriodicUnit" >
                                    <option value="">请选择</option>
                                    <option value="0">周</option>
                                    <option value="1">月</option>
                                </select>
                            </div>
                        </div>


                        <div class="layui-form-item" >
                            <label class="layui-form-label">状态</label>
                            <div class="layui-input-block">
                                <select name="inspPlStatus" class="inspPlStatus">
                                    <option value="1">启用</option>
                                    <option value="0">停用</option>

                                </select>
                            </div>
                        </div>


                    </div>

                </div>
                <div class="col-xs-12" style="margin-bottom: 50px;">
                    <div class="layui-form-item" pane>

                        <div class="layui-input-block" style="margin-left: 0">
                            <button  type="button" class="layui-btn  layui-btn-sm addNew" data-type="addNew"  style="background-color: #003366">
                                <i class="layui-icon layui-icon-add-1"></i>&nbsp;添加
                            </button>

                            <button type="button" class="layui-btn  layui-btn-sm setNew" data-type="setNew" id="setTable">设置巡检标准</button>

                            <!-- <button type="button" class="layui-btn layui-btn-danger layui-btn-sm editNew"
                                     data-id="table"   style="background-color: #FFB800">
                                 <i  class="fas fa-pen"></i>    修改
                             </button>-->

                            <button type="button" class="layui-btn layui-btn-sm delNew" data-type="delNew"   style="background-color: #CC0033">
                                <i  class="layui-icon layui-icon-delete"></i>&nbsp;删除
                            </button>
                        </div>

                    </div>

                    <table id="table" lay-filter="table"></table>
                </div>
             <!--   <div class="col-xs-12" style="margin-bottom: 50px;">
                    <div class="layui-form-item" pane >

                        <div class="layui-input-block  demoTable" style="margin-left: 0">
                            <button  type="button" class="layui-btn layui-btn-normal layui-btn-sm addNew"
                                     data-type="addNew"  style="background-color: #003366">
                                <i class="fas fa-plus"></i>&nbsp;添加
                            </button>

                            <button type="button" class="layui-btn layui-btn-danger layui-btn-sm setNew"
                                    data-type="setNew" id="setTable" style="background-color: #CC0033">
                                设置巡检标准
                            </button>

                            <button type="button" class="layui-btn layui-btn-danger layui-btn-sm delNew"
                                    data-type="delNew"   style="background-color: #CC0033">
                                <i  class="fas fa-trash-alt"></i>&nbsp;删除
                            </button>
                           &lt;!&ndash; <p style="color: red;display: block;"><i style="font-weight: bolder">注:</i>设置巡检标准将会覆盖原来设置的巡检标准</p>
&ndash;&gt;

                        </div>


                    </div>

                    <table id="table" lay-filter="table"></table>
                </div>-->

                <div class="layui-row"  style="float: right;margin-right: 20%;">
                    <div class="col-xs-6">
                        <button class="layui-btn " id="sumBer">提 交</button>
                    </div>

                    <div class="col-xs-6">
                        <button class="layui-btn layui-btn-warm" id="tui" >退出</button>
                    </div>


                </div>

            </div>
        </form>
    </div>
</div>
<script type="text/html" id="barDemo">
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a>
</script>
<script>
    layui.use(['form','table', 'layedit', 'laydate'], function(){
        var form = layui.form
            ,layer = layui.layer
            ,layedit = layui.layedit
            ,table = layui.table
            ,laydate = layui.laydate;
        form.render();
        var tessNum =[];
        var Numb = [];
        var bZ = [];
        var nBz = [];

        renderMod = {
            table: {
                table: [
                    {
                        elem: "#table",
                        id: "table",
                        cols: [[ //表头
                            {type: "checkbox"}
                            , {field: 'bmName', title: '使用部门', minWidth: 150}
                            , {field: 'eqSbbh', title: '设备编号', minWidth: 150}
                            , {field: 'eqName', title: '设备名称', minWidth: 150}
                            , {field: 'eqXh', title: '设备型号', minWidth: 150}
                            , {field: 'zt', title: '状态', Width: 80 }
                            ,{fixed: 'right',title: '巡检标准', width:150, align:'center', toolbar: '#barDemo'}
                        ]]
                        , toolbar: false
                        , page: false
                        , height: "200"
                        ,data:[]
                        , text: {
                            none: "请点击上方添加按钮添加数据！"
                        }
                        , done: function (res, curr, count) {
                            /*   删除*/
                            $(".delNew").off("click").on("click",function(){
                                var checkedArr = [];
                                for (var i = 0; i < table.cache.table.length; i++) {
                                    if (table.cache.table[i].LAY_CHECKED == true){
                                        checkedArr.push(i);
                                    }
                                }
                                if (checkedArr.length == 0){
                                    layer.msg("尚未选择", { icon: 5 });
                                }
                                var eqSbbhs =[];
                                for (var i = 0; i < checkedArr.length; i++){
                                    var t = checkedArr[i];
                                    var t = checkedArr[i];
                                    if (t === 0){
                                        t = checkedArr[i];
                                    } else{
                                        t = checkedArr[i] - 1;
                                    }
                                    eqSbbhs.push(table.cache.table[t].eqSbbh);
                                    console.log(eqSbbhs);
                                    tessNum.splice(t,1);
                                    $(".layui-table-view .layui-table tbody tr[data-index=" + checkedArr[i] + "]").remove();
                                }
                                if (tessNum !== undefined) {
                                    //向表格中添加数据
                                    table.reload('table', {
                                        data : tessNum
                                    });
                                    layui.form.render();
                                }
                                checkedArr.length = 0;//清除数组
                                layer.msg('删除成功');
                                table.reload();
                                $.ajax({
                                    url:'/inspection/otherfunction/updateEqSbbh1',
                                    type:"POST",
                                    async: false,/*同步传输*/
                                    data:JSON.stringify(eqSbbhs),
                                    dataType:'JSON',
                                    contentType:'application/json'

                                })
                            });
                            /*  增加*/
                            $(".addNew").off("click").on("click",function(){
                                console.log(tessNum);
                                if (tessNum.length === 0){
                                    tessNum = Numb;
                                } else {
                                    tessNum = tessNum;
                                }
                                layer.open({
                                    type: 2
                                    ,title: '添加设备'
                                    ,area: ['95%', '95%']
                                    ,content:"./index1New-new.html"
                                    ,end :function () {
                                        var re = window.localStorage.getItem("forMod");
                                        var res = JSON.parse(re);
                                        console.log(res);
                                        if (res === null) {
                                            return;
                                        }else{
                                            for(var i = 0; i < res.length; i++){
                                                tessNum.push(res[i]);
                                            }
                                            console.log(tessNum);
                                            window.localStorage.removeItem("forMod");

                                            if (tessNum !== undefined) {
                                                //向表格中添加数据
                                                table.reload('table', {
                                                    data: tessNum
                                                });
                                                layui.form.render();
                                            }
                                        }
                                    }
                                });
                            });
                            /*  设置*/
                            $(".setNew").off("click").on("click",function(){
                               if (tessNum.length === 0){
                                   tessNum = Numb;
                               } else {
                                   tessNum = tessNum;
                               }
                                var Ty = [];
                                for (var i = 0; i < table.cache.table.length; i++) {
                                    if (table.cache.table[i].LAY_CHECKED == true){
                                        Ty.push(i);
                                    }
                                }
                                if (Ty.length === 0){
                                    layer.msg("尚未选择", { icon: 5 });
                                    return;
                                }else{
                                    layer.open({
                                        type: 2 //此处以iframe举例
                                        ,title: '巡检标准'
                                        ,area: ['85%', '85%']
                                        ,content:"./index1-new-inspection.html"
                                        ,success : function () {
                                        }
                                        ,end :function () {
                                            var Tar = [];
                                            for (var i = 0; i < table.cache.table.length; i++) {
                                                if (table.cache.table[i].LAY_CHECKED == true){
                                                    Tar.push(i);
                                                }
                                            }
                                            console.log(Tar);
                                            for (var i = 0; i < Tar.length; i++){
                                                var t =  Tar[i];
                                                var aLla = sessionStorage.getItem("al");
                                                var aBz = sessionStorage.getItem("alBz");
                                                if (aLla === null){
                                                    return;
                                                }else{
                                                    console.log(tessNum[t]);
                                                    tessNum[t]['inspPlStandards'] = JSON.parse(aLla);
                                                    nBz[t] = JSON.parse(aBz);
                                                    window.localStorage.removeItem("al");
                                                    window.localStorage.removeItem("alBz");
                                                    if (aLla !== null){
                                                        tessNum[t]['zt'] = "已设置";
                                                    }
                                                    if (tessNum !== undefined) {
                                                        if(tessNum[0] === null){
                                                            return;
                                                        }else {
                                                            table.reload('table', {
                                                                data: tessNum
                                                            });

                                                            layui.form.render();
                                                        }
                                                    }
                                                }

                                            }
                                        }
                                    });
                                }
                                Ty.length = 0;//清除数组
                                table.reload("table");
                            });
                        }
                    }
                ]
            }
             , form: {
                 date: [
                     {
                         elem: '#date',
                         value: today0,
                         trigger:"click"
                     },
                     {
                         elem: '#date1',
                         value: today0,
                         trigger:"click"
                     }
                 ]
             }
        };

        $(function(){
            var url = window.location.search;
            var inspPlId =  $.getUrlParam("id");
            console.log(inspPlId);
            $.ajax({
                url : "/inspection/inspPl/selectInspPlanById",
                type : 'POST',
                data : {"inspPlId": inspPlId},
                dataType:'json',
                success : function(data){
                    if(data !== null){
                        console.log(data);
                        $(".inspPlanId").val(data.data.inspPlanId);
                        $(".inspPlName").val(data.data.inspPlName);
                        $(".inspPlCreateTime").val(data.data.inspPlCreateTime);
                        $(".inspPlNote").val(data.data.inspPlNote);
                       $(".inspPlLastTime").val(data.data.inspPlLastTime);
                        $("#inspPlPeriod").val(data.data.inspPlPeriod);


                        var num = 0;
                        if (data.data.inspPlStatus !== "0" || data.data.inspPlStatus !== 0){
                            num = 1;
                        };

                        $("#inspPlStatus option[value='"+  num +"']").prop("selected","selected");
                        $("#inspPlPeriodicUnit option[value='"+  data.data.inspPlPeriodicUnit +"']").prop("selected","selected");
                        $("#inspPlExecutorType option[value='"+  data.data.inspPlExecutorType +"']").prop("selected","selected");
                        $("#inspPlType option[value='"+  data.data.inspPlType +"']").prop("selected","selected");

                        var t , neq = [],mmq=[],n = "",m= "";
                        for (t in data.data.inspPlAuditor) {
                            if (data.data.inspPlAuditor[t] === "+"){
                                continue;
                            }

                            if (data.data.inspPlAuditor[t] <= "9"){
                                neq.push(data.data.inspPlAuditor[t]);
                            }else{
                                mmq.push(data.data.inspPlAuditor[t]);
                            }
                        }
                        for (var j = 0; j< neq.length; j ++ ){
                            n += neq[j];
                        }
                        for (var j = 0; j< mmq.length; j ++ ){
                            m += mmq[j];
                        }
                        $(".inspPlSpare4").val(m);
                        $("#inspPlAuditor").val(n);



                        Numb = data.data.inspPlanEquipmentVo1s;
                        for (var i = 0 ; i < Numb.length; i++){
                            Numb[i]["zt"] = "已设置";
                        }
                        table.reload('table', {
                            data : Numb
                        });
                        for (var i = 0; i < Numb.length; i++){
                            bZ.push(Numb[i].inspPlStandards);
                        }

                        layui.form.render();
                        // 记得重新渲染表单/*form.render();*/
                        /*   form.render();*/
                    }else{
                        alert("查询为空");
                    }
                },
                error:function (data) {
                    alert("查询失败");
                    console.log(data);
                }
            });
            tessNum = Numb;
            nBz = bZ;
        });



         $("#tui").off("click").on("click",function(){

             $.ajax({
                     url:'/inspection/otherfunction/updateSelectionToZero',
                     async: false,/*同步传输*/
                     success: function(res){
                         if(res.code == 0 ){
                              window.location.href = "javascript:history.go(-1)";
                             var index = parent.layer.getFrameIndex(window.name);
                             parent.location.reload();
                         }else{
                             alert(res.msg);
                         }
                     },
                     error:function (data) {
                     }
                 }) ;

         });

        table.on('tool(table)', function(obj){
            var data = obj.data;
            console.log(bZ);
            console.log(nBz);

            if(obj.event === 'detail'){
                if (tessNum.length === 0){
                    tessNum = Numb;
                } else{
                    tessNum = tessNum;
                }
                console.log(data);
                var n = 0;
                var Biao = [],biaoZhun = [],zhun = [],nely = [];
                var numZh = {};
                if ( nBz.length === 0){
                    bZ = bZ;
                } else{
                    bZ = nBz;
                }
               /* console.log(data.inspPlStandards);
                console.log(tessNum);*/
              for (var i = 0; i < tessNum.length; i++){
                  if (tessNum[i].eqSbbh === data.eqSbbh) {
                      Biao.push(bZ[i]);
                  }
              } 
                console.log(Biao);
                for (var i = 0; i < Biao[0].length; i++){
                    n += 1;
                    if (n <= 3){
                        biaoZhun.push(Biao[0][i]);
                        if ( n === 3){
                            console.log(biaoZhun);
                            zhun.push(biaoZhun);
                            n = 0;
                            biaoZhun = [];
                        }
                    }
                }
                console.log(biaoZhun);
                console.log(zhun);
                for (var j = 0; j < zhun.length; j++){
                    numZh["inspPlStandardId"] = zhun[j][0];
                    numZh["inspPlStandardName"] = zhun[j][1];
                    numZh["inspPlStandardDescription"] = zhun[j][2];
                    nely.push(numZh);
                    numZh = {};
                }
                 console.log(nely);
                var danly = JSON.stringify(nely);
                 console.log(danly);
                window.localStorage.setItem('biaoZhun', danly);
                layui.layer.open({
                    title: "巡检标准",
                    type: 2,
                    content:" ./index1-edit-biaoz.html",//弹出层页面
                    area: ['94%', '95%']
                });
            }
        });


        $("#sumBer").off("click").on("click",function(){
            if (tessNum.length === 0){
                tessNum = Numb;
            } else {
                tessNum = tessNum;
            }
            layui.use('layer',function() {
                var layer = layui.layer;
                    if (tessNum.length === 0 ){
                    tessNum = Numb;
                }
                    if ($(".inspPlName").val() == "") {
                        layer.msg("计划名称尚未填写", {icon: 2});
                        return;
                    }
                    if ($(".inspPlCreateTime").val() == "") {
                        layer.msg("指定时间尚未填写", {icon: 2});
                        return;
                    }
                if ($(".inspPlLastTime").val() == "") {
                    layer.msg("计划时间未填写", {icon: 2});
                    return;
                }
                if ($("#inspPlPeriod").val() == "") {
                    layer.msg("巡检周期未填写", {icon: 2});
                    return;
                }
                if ($("#inspPlPeriodicUnit").val()  == "") {
                    layer.msg("周期单位未填写", {icon: 2});
                    return;
                }
                    if ($(".inspPlPlanner").val() == "") {
                        layer.msg("制定人尚未填写", {icon: 2});
                        return;
                    }
                    if ($(".inspPlNote").val() == "") {
                        layer.msg("备注尚未填写", {icon: 2});
                        return;
                    }
                    if ($(".inspPlAuditor").val() == "") {
                        layer.msg("审核人尚未填写", {icon: 2});
                        return;
                    }
                if ($("#inspPlExecutorType").val() == "") {

                    layer.msg("执行人类别尚未填写", {icon: 2});
                    return ;
                }

                if ($("#inspPlType").val()  == "") {
                    layer.msg("巡检类型未填写", {icon: 2});
                    return;
                }

                /*if(tessNum.length === 0){
                    layer.msg("巡检设备未选择", {icon: 2});
                    return;
                }*/
                    /*for (var i = 0; i < tessNum.length; i++){
                        for (var j = 0; j < tessNum[i].inspPlanEquipmentVos.length; j++ ){
                            if(tessNum[i].inspPlanEquipmentVos[j].length == 0){
                                layer.msg("设备信息未添加", {icon: 2});
                                return;
                            }
                        }
                    }*/
                if(tessNum.length == 0){
                    layer.msg("设备信息未添加", {icon: 2});
                    return;
                }

                    var inspPlanVo = {};
                    console.log(tessNum);
                    inspPlanVo["inspPlanId"] = $(".inspPlanId").val();
                    inspPlanVo["inspPlName"] = $(".inspPlName").val();
                    inspPlanVo["inspPlSpare4"] = $(".inspPlSpare4").val();
                    inspPlanVo["inspPlCreateTime"] = $(".inspPlCreateTime").val();
                    inspPlanVo["inspPlPlanner"] = $("#inspPlPlanner").val();
                    inspPlanVo["inspPlNote"] = $(".inspPlNote").val();
                    inspPlanVo["inspPlAuditor"] = $("#inspPlAuditor").val();
                    inspPlanVo["inspPlStatus"] = $(".inspPlStatus").val();
                    inspPlanVo["inspPlLastTime"] = $(".inspPlLastTime").val();
                    inspPlanVo["inspPlPeriod"] = $("#inspPlPeriod").val();
                    inspPlanVo["inspPlPeriodicUnit"] = $("#inspPlPeriodicUnit").val();
                inspPlanVo["inspPlExecutorType"] = $("#inspPlExecutorType").val();

                inspPlanVo["inspPlType"] = $("#inspPlType").val();
                   /* for(var i = 0; i < )*/
                var tr = [];
                for (var i = 0; i < tessNum.length; i++){
                        if (tessNum[i].bmName !== undefined){
                            delete  tessNum[i].bmName;
                            delete  tessNum[i].eqName;
                            delete  tessNum[i].eqXh;
                            delete  tessNum[i].zt;
                            console.log(tessNum[i].inspPlStandardId);
                            if (tessNum[i].inspPlStandardId !== undefined){
                                tessNum[i]["inspPlStandards"] = tessNum[i].inspPlStandardId;
                                delete  tessNum[i].inspPlanEquipmentVos[j].inspPlStandardId;
                            } else {
                                console.log(tessNum[i].inspPlStandards);
                                if (tessNum[i].inspPlStandards === undefined){
                                    layer.msg("设备巡检标准未添加", {icon: 2});
                                    return;
                                }
                                for (var t = 0; t < tessNum[i].inspPlStandards.length; t++){
                                    var n = Number(tessNum[i].inspPlStandards[t]);
                                 /*   console.log(n);*/
                                    if (!isNaN(n))
                                    {
                                        tr.push(tessNum[i].inspPlStandards[t]);
                                    }
                                }
                                console.log(tr);
                                tessNum[i]["inspPlStandards"] = tr;
                                tr = [];
                            }
                        }

                }

                console.log(tessNum);
                inspPlanVo["inspPlanEquipmentVos"] = tessNum;
                    console.log(inspPlanVo);
                    $.ajax({
                        url: '/inspection/inspPl/updateInspPlan',
                        type:"POST",
                        async: false,/*同步传输*/
                        data:JSON.stringify(inspPlanVo),
                        dataType:'JSON',
                        contentType:'application/json' ,
                        success: function(res){
                            if(res.code == 0 ){
                                layer.msg("请求发送成功！",{icon: 6,time:3000});
                                parent.location.reload();
                            }else{
                                alert(res.msg);
                            }
                        },
                        error:function (data) {
                            alert(data);
                        }
                    }) ;
            });
            return false;

        })

    });
</script>

</body>
</html>