<!DOCTYPE html>
<html lang="zh_CN" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <meta charset="UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <title>医疗设备智能管理系统</title>
    <link rel="stylesheet" type="text/css" href="/static/admin/layui/css/layui.css"/>
    <link rel="stylesheet" type="text/css" href="/static/admin/css/admin.css"/>
    <script src="/static/admin/js/jquery-3.3.1.min.js"></script>
    <!--[if IE 8]>
    <script type="text/javascript" src="/static/admin/js/jquery-1.11.3.min.js"></script>
    <![endif]-->
    <script src="/static/admin/js/basic.js"></script>
    <style>
        .loading {
            font-size: 2.5rem;
            color: #fff;
            text-align: center;
            vertical-align: middle;
            margin: 20% 0;
            letter-spacing: 5px;
        }

        .loading i {
            font-size: 4rem;
        }
        .showMsg{
            display:block;
        }
    </style>

</head>
<body>
<div id="begin"></div>
<script>markPage();</script>
<div class="main-layout" id='main-layout'>
    <!--侧边栏-->
    <div class="main-layout-side">
        <!--LOGO-->
        <div class="m-logo">
            <img src="/" alt="LOGO">
        </div>
        <!--site Map-->
        <div class="map_site">
            位置：首页
        </div>
        <!--左侧主列表-->
        <ul class="layui-nav layui-nav-tree" lay-shrink="all" lay-filter="leftNav" id="main_nav_list">
            <li class="layui-nav-item">
                <a href="javascript:void(0);" id="goHome"><i class="fas fa-fas fa-home"></i>首页</a>
            </li>
        </ul>
    </div>
    <!--右侧内容-->
    <div class="main-layout-container">
        <!--头部-->
        <div class="main-layout-header">
            <div class="menu-btn menu-btn1" id="hideBtn">
                <a href="javascript:void(0);">
                    <i class="fas fa-bars" id="sbars"></i>
                </a>
            </div>
            <!--顶部导航-->
            <div class="menus">
                <div class="layui-nav">
                    <div class="menus_con">
                    </div>
                </div>
            </div>
            <!--用户信息-->
            <div class="info1">
                <div class="visible-xs visible-sm info">
                    <i class="fas fa-info"></i>
                </div>
                <ul class="layui-nav conts" lay-filter="rightNav" style="margin-right:20px;">
                    <li class="layui-nav-item items1">
                        <a href="javascript:;" id="lockSys" data-text="系统锁定">
                            <i class="fas fa-lock"></i>
                        </a>
                    </li>
                    <li class="layui-nav-item items1">
                        <a href="javascript:" style="padding:0 10px;overflow:hidden;">
                            <img src="/static/admin/images/man.png" class="user_head" alt="用户头像">
                            <p class="names">
                                <span class="h_name"></span>
                                <span class="h_room"></span>
                            </p>
                        </a>
                        <dl class="layui-nav-child">
                            <dd><a href="javascript:;" data-url="./global/info.html" data-id='x222' data-text="信息管理">信息管理</a></dd>
                            <dd><a href="javascript:" class="quit">退出</a></dd>
                        </dl>
                    </li>
                </ul>
            </div>
        </div>
        <!--主体内容-->
        <div class="main-layout-body">
            <!--tab 切换-->
            <div class="layui-tab layui-tab-brief main-layout-tab" lay-filter="tab" lay-allowClose="true" style="background:#fff;">
                <ul class="layui-tab-title navs" style="margin-right:55px;">
                    <li class="layui-this welcome" id="refresh_home">系统主页</li>
                </ul>
                <!--右侧折叠副列表-->
                <div class="tools">
                    <div class="tools_more" title="点击固定/解除">
                        <i class="fas fa-th-large"></i>
                    </div>
                    <ul class="cts2">
                        <!--动态列表-->
                    </ul>
                </div>
                <div class="layui-tab-content">
                    <div class="layui-tab-item layui-show" style="background: #f5f5f5;">
                        <!--内容页-->
                        <iframe src="welcome.html" width="100%" height="100%" name="iframe" scrolling="auto" class="iframe" framborder="0" id="home"></iframe>
                        <!--end-->
                    </div>
                </div>
            </div>
        </div>
        <!--<div class="jlsj">
            <img src="../static/admin/images/footerlogo.png" alt="健龙世纪">
            &lt;!&ndash;<p>医疗设备数字化管理产品和服务的</p>&ndash;&gt;
            &lt;!&ndash;<p><b>开拓者 领航者</b></p>&ndash;&gt;
        </div>-->
    </div>
    <!--遮罩-->
    <div class="main-mask"></div>
    <div class="hide" id="lock">
        <form class="layui-form" action="">
            <div class="container" style="margin-top:20%">
                <div class="row">
                    <div class="bg" style="width:300px;margin: 0 auto;">
                        <h1 style="text-align: center;margin-bottom: 20px;">系统已锁定</h1>
                        <input type="text" id="uKey" lay-verify="required" placeholder="账户密码" autocomplete="off" class="layui-input">
                        <button class="layui-btn layui-btn-normal btn layui-btn-fluid" lay-filter="login" id="check-btn" style="margin-top: 20px;">解锁</button>
                        <span> </span>
                        <button class="layui-btn layui-btn-warm btn layui-btn-fluid quit" style="margin-top: 20px;">登出</button>
                    </div>

                </div>
            </div>

        </form>
    </div>
</div>
<script src="/static/admin/js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="/static/admin/js/nav_shiro.js" type="text/javascript" charset="utf-8"></script>
<script>
    layui.use('element', function () {
        var element = layui.element;
        $(function () {
            var emp = tempValue("rl","emp",false)
                ,glo = tempValue("rl","glo",false)
                ,loc = tempValue("pageLock","lock",false)
                ,f = tempValue("index", "f",null)
                ,uu = $.getUrlHash("url")
                , tt = $.getUrlHash("title") || "新窗口"
                , ii = $.getUrlHash("id") || "n9999";
            //http://localhost/admin/index/index.html?p=home#url=./repair.html#title=百度首页#id=666666
            //判断点 #url=./repair.html #title=百度首页 #id=666666
            //获取URL HASH值打开新页面
            if (uu !== null) {
                element.tabAdd('tab', {
                    title: tt,
                    content: '<iframe src="' + uu + '" name="iframe"' + ii + '"" class="iframe" framborder="0" data-id="' + ii + '" scrolling="auto" width="100%"  height="100%"></iframe>',
                    id: ii
                });
                element.tabChange('tab', ii);
                window.location.hash = "";
            }

            //获取用户信息
            if (emp) {
                $(".h_name").text(emp.userXm);
                $(".h_room").text(emp.bmName);
                if (emp.sex === "女") {
                    $(".user_head").attr("src", "/static/admin/images/woman.png")
                }
            }else{
                layer.alert("无法获取用户信息，请重新登录！",function (index) {
                    layer.close(index);
                    location.href = "/logout"
                })
            }

            //LOGO设置
            if(glo){
                $(".m-logo img").attr("src",glo.logo)
            }

            //锁定判断
            if(loc || window.locked){
                goLock(true);
            }

            //页面登出事件
            $(".quit").on("click", function () {
                layer.confirm("确定要退出吗？", function () {
                    location.href = "/logout";
                    tempValue("pageLock","lock",null);
                    window.locked = false;
                });
                return false;
            });

            //页面锁定事件
            $("#lockSys").on("click",goLock);

            function goLock(cc){
                //console.log(cc);
                if(cc !== true){
                    layer.confirm("确认锁定系统吗？",goo);
                }else{
                    goo();
                }
                function goo(index){
                    layui.sessionData("pageLock",{
                        key:"lock",
                        value:"true"
                    });
                    window.locked = true;
                    layer.close(index);
                    var inn = layOpen({
                        type: 1,
                        content: $("#lock"),
                        closeBtn: 0,
                        maxmin: false,
                        fixed: true,
                        resize: false,
                        title: false,
                        area: ["100%", "100%"]
                    });
                    $("#check-btn").on("click", function () {
                        var k = $("#uKey").val();
                        if(!k){
                            layer.alert("请输入密码！");
                            return false;
                        }
                        $.ajax({
                            url:"/hospital/lock",
                            type:"POST",
                            data:{
                                userId:emp.userId,
                                userPwd:k
                            },
                            success:function(res){
                                if(res.code === 0){
                                    tempValue("pageLock","lock",null);
                                    window.locked = false;
                                    layer.close(inn);
                                }else{
                                    layer.alert("系统锁定解除失败！");
                                    $("#uKey").val("");
                                    console.log(res);
                                }
                            },
                            error:function(res){
                                layer.alert("数据请求错误！");
                                console.log(res);
                            }
                        });
                        return false;
                    })
                }
            }

            //判断当前页面，标示出当前页面的导航栏（改变导航栏底色）并禁止点击
            (function () {
                var page = $.getUrlParam("p");
                var $a = $(".menu-btn").find("a[href='?p=" + page + "']");
                if ($a.length > 0) {
                    $a.css("background", "#089ce20f");
                    $a.on("click", function () {
                        return false;
                    });
                }
            })();

            //判断主页(welcome.html)点击时渲染是否正确，不正确重载主页
            $("#refresh_home").click(function () {
                if ($(this).hasClass("layui-this")) {
                    return false;
                }
                setTimeout(function () {
                    document.getElementById('home').contentWindow.location.reload();
                }, 10)
            });
            //展开第一项列表

            //读取本地存储中的页面ID并打开页面（仅限当前页面存在的页面，主要用于welcome页跳转）
            if (f && typeof Number(f) === "number") {
                var ne =$("a[data-id='" + Number(f) + "']");
                if(ne.length>0){
                    ne[0].click();
                }
            }

            $(".tools").on('click',function (event) {
                event.stopPropagation();
                $(".cts2").toggleClass("showMsg");
                var $con = $(".layui-tab-content");
                $con.parent().append(
                    $("<div>").css({
                        width:"100%",
                        height:"100%",
                        position:"absolute",
                        top:"40px",
                        left:"0",
                        "z-index":99
                    }).attr("class","showId").on("click",function () {
                        $(".cts2").removeClass("showMsg");
                        $(".conts").removeClass("showMsg");
                        $(this).remove();
                    })
                )
            });

            $(".info1").on("click",function (event) {
                event.stopPropagation();
                $(".conts").toggleClass("showMsg");
                var $con = $(".layui-tab-content");
                $con.parent().append(
                    $("<div>").css({
                        width:"100%",
                        height:"100%",
                        position:"absolute",
                        top:"40px",
                        left:"0",
                        "z-index":99
                    }).attr("class","showId").on("click",function () {
                        $(".cts2").removeClass("showMsg");
                        $(".conts").removeClass("showMsg");
                        $(this).remove();
                    })
                )
            });

            $(document).on("click",function(){
                $(".cts2").removeClass("showMsg");
                $(".conts").removeClass("showMsg");
                $(".showId").remove();
            });

            $("#goHome").on("click",function () {
                if($.getUrlParam("p")!=="home"){
                    layer.confirm("即将重置所有已打开的页面，是否确认返回首页？",function () {
                        location.href = "?p=home";
                    });
                }else{
                    layer.alert("您已处于首页！")
                }
            });
        })
    });
</script>
</body>
</html>
